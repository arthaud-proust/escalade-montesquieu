const months=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];try{window._last_message_id=window._messages[window._messages.length-1].id,localStorage.setItem(`${window._forum}.last_message`,new Date(window._messages[window._messages.length-1].created_at).getTime())}catch(e){window._last_message_id=0}const contextMenuItems=[["Mentionner","mention"],["Voir le profil","profile"]],contextMenuContent=contextMenuItems.map(e=>`<span onclick="${e[1]}()">${e[0]}</span>`).join(""),formUrlEncoded=e=>Object.keys(e).reduce((t,s)=>t+`&${s}=${encodeURIComponent(e[s])}`,"");function profile(){let e=$("#"+$("#contextMenu").attr("data-message")).find(".MessageCard-author").attr("href");window.open(e),contextMenuOff()}function mention(){let e=$("#MessageForm-input").val(),t="@"+$("#"+$("#contextMenu").attr("data-message")).find(".MessageCard-author-name").text().replace(/\s{2,}/g,"").replace(/\s/g,"_").toLowerCase();console.log(t),e.includes(t)||$("#MessageForm-input").val(t+" "+e).focus(),contextMenuOff()}function contextMenu(e){e.preventDefault(),$("#contextMenu").length?$("#contextMenu").attr("data-message",$(e.target).parents(".MessageCard")[0].id):$("body").append(`\n        <div id="contextMenu" data-message="${$(e.target).parents(".MessageCard")[0].id}">\n            ${contextMenuContent}\n        </div>\n        `),clickCoords=getPosition(e),menuWidth=$("#contextMenu").offsetWidth+4,menuHeight=$("#contextMenu").offsetHeight+4,windowWidth=$("#contextMenu").innerWidth(),windowHeight=$("#contextMenu").innerHeight(),windowWidth-clickCoords.x<menuWidth?$("#contextMenu").css("left",windowWidth-menuWidth+"px"):$("#contextMenu").css("left",clickCoords.x+"px"),windowHeight-clickCoords.y<menuHeight?$("#contextMenu").css("top",windowHeight-menuHeight+"px"):$("#contextMenu").css("top",clickCoords.y+"px"),$("#contextMenu").fadeIn("fast")}function getPosition(e){var t=0,s=0;if(!e)e=window.event;return e.pageX||e.pageY?(t=e.pageX,s=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t,y:s}}function contextMenuOff(){$("#contextMenu").fadeOut("fast")}function getDate(e,t=!0,s=!1){let n=void 0===e?"":new Date(e.replace(/-/g,"/"));const a=e=>0==e?"":1==e.toString().length?"0"+e:e;return`${n.getDate()} ${months[n.getMonth()]} ${s?`<small>${n.getFullYear()}</small>`:""} ${t?`à ${a(n.getHours())}h${a(n.getMinutes())}`:""}`}function getMessage(e){const t=anchorme({input:e.content,extensions:[{test:/@(\w|_)+/gi,transform:e=>`<a href="http://escalade-montesquieu.fr/profil/${e.substr(1).replace(/(_)+/gi," ")}">${e}</a>`}]});return`\n    <div class="MessageCard ${e.author==window._user?"myMessage":"theirMessage"}" id="message-${e.id}">\n        <a class="MessageCard-author" href="/profil/${e.author_uuid}" target="blank">\n                <img class="MessageCard-author-img" src="/profil/${e.author_uuid}/img">\n                <h5 class="MessageCard-author-name">\n                    ${e.author}\n                </h5>\n            </a>\n        <p class="MessageCard-text ">\n            ${t}\n        </p>\n        <span class="MessageCard-datetime">${getDate(e.created_at)}</span>\n    </div>\n    `}function addMessage(e){$("#MessagesList").append(getMessage(e)),$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},500),$(".MessageCard-author").on("click",contextMenu),$(".MessageCard-author").on("contextmenu",contextMenu)}function rendMessages(e){$("#MessagesList").html(e.map(e=>getMessage(e))),setTimeout(()=>{$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},250)},500),$(".MessageCard-author").on("click",contextMenu),$(".MessageCard-author").on("contextmenu",contextMenu)}function sendMessage(){if(!$("#MessageForm-input").val().match(/\S/gm))return;let e=$("#MessageForm-input").val();$("#MessageForm-input").val(""),$(".MessageForm").addClass("inProgress"),axios({method:"post",url:"/message/send",data:{forum:window._forum,content:e}}).then(e=>{$(".MessageForm").removeClass("inProgress"),window._last_message_id=e.data.message.id})}function fetchMessages(){return new Promise(e=>{console.log(`Fetching messages... (last: ${window._last_message_id})`),axios({method:"post",url:"https://escalade-montesquieu-pusher.herokuapp.com/fetch",timeout:3e4,data:formUrlEncoded({last_message_id:window._last_message_id,forum:window._forum})}).then(t=>{t.data.forEach(e=>{e.id>window._last_message_id&&(window._last_message_id=e.id,localStorage.setItem(`${window._forum}.last_message`,JSON.stringify(new Date(e.created_at).getTime()))),addMessage(e),window._messages.push(e)}),fetchMessages().then(()=>e(t))}).catch(e=>{fetchMessages()})})}$(()=>{$("#MessageForm-send").click(sendMessage),$("#MessageForm-input").keyup(function(e){13==e.which&&sendMessage()}),rendMessages(window._messages),fetchMessages(),window.onresize=contextMenuOff,window.onkeyup=function(e){27===e.keyCode&&contextMenuOff()},document.addEventListener("click",function(e){$(e.target).attr("class")&&!$(e.target).attr("class").includes("MessageCard-author")&&(1===(e.which||e.button)&&contextMenuOff())})});
