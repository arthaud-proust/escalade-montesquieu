const publicVapidKey="BH25QhGzdhhFsj8D0Ws71rdpwvW4q_PuqHZRDmZpRoDlItnhRMQ9zvnTT4rfIklgWKxIkFfqqMu49ibGqfiaGlc";function getForumsLastMessages(){let e={forums:{}};for(const t of Object.keys(localStorage).filter(e=>e.includes(".last_message")))e.forums[t.split(".")[0]]=localStorage.getItem(t);axios({method:"post",url:`${window._push_host}/last-messages`,data:JSON.stringify(e),headers:{"content-type":"application/json"}}).then(e=>{e.data;let t=!1;for(const[s,a]of Object.entries(e.data))console.log(`${s.split(".")[0]}: ${a?"nouveaux messages":"Ã  jour"}`),a&&($(`.link-forum[data-forum="${s.split(".")[0]}"]`).addClass("has-new-messages"),t=!0);t&&($(".nav-link-forums").addClass("has-new-messages"),$(".navbar-toggler").addClass("has-new-messages"))})}async function send(){navigator.serviceWorker.register("/js/worker.js").then(onRegistration)}function onRegistration(e){e.waiting&&e.waiting.addEventListener("statechange",onStateChange("waiting",e)),e.installing&&e.installing.addEventListener("statechange",onStateChange("installing",e)),e.active&&e.active.addEventListener("statechange",onStateChange("active",e))}function onStateChange(e,t){return function(s){console.log(`From ${e} to ${s.target.state}`),"activated"==s.target.state&&registerPush(t)}}function registerPush(e){e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(publicVapidKey)}).then(function(e){console.log("Subscribing"),fetch(`${window._push_host}/subscribe`,{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})})}function urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),a=new Uint8Array(s.length);for(let e=0;e<s.length;++e)a[e]=s.charCodeAt(e);return a}window._push_host="https://escalade-montesquieu-pusher.herokuapp.com","serviceWorker"in navigator&&send().catch(e=>console.error(e)),getForumsLastMessages();
