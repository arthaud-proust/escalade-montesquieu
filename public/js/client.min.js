const publicVapidKey="BH25QhGzdhhFsj8D0Ws71rdpwvW4q_PuqHZRDmZpRoDlItnhRMQ9zvnTT4rfIklgWKxIkFfqqMu49ibGqfiaGlc";function getForumsLastMessages(){axios({method:"get",url:`${window._push_host}/last-messages`}).then(e=>{let a=!1;e.data.forEach(e=>{void 0!==localStorage.getItem(e.name)?(console.log(JSON.parse(e.last.timestamp)),console.log(JSON.parse(localStorage.getItem(e.name+".last_message"))),JSON.parse(e.last.timestamp)>JSON.parse(localStorage.getItem(e.name+".last_message"))?(a=!0,console.log(`${e.name.split(".")[0]}: nouveaux messages (${e.last.date})`),$(`.link-forum[data-forum="${e.name.split(".")[0]}"]`).addClass("has-new-messages"),a=!0):console.log(`${e.name.split(".")[0]}: Ã  jour (${e.last.date})`)):$(`.link-forum[data-forum="${e.name.split(".")[0]}"]`).addClass("has-new-messages")}),console.log(a),a&&($(".nav-link-forums").addClass("has-new-messages"),$(".navbar-toggler").addClass("has-new-messages"))})}async function send(){navigator.serviceWorker.register("/js/worker.js").then(onRegistration)}function onRegistration(e){e.waiting&&e.waiting.addEventListener("statechange",onStateChange("waiting",e)),e.installing&&e.installing.addEventListener("statechange",onStateChange("installing",e)),e.active&&e.active.addEventListener("statechange",onStateChange("active",e))}function onStateChange(e,a){return function(t){console.log(`From ${e} to ${t.target.state}`),"activated"==t.target.state&&registerPush(a)}}function registerPush(e){e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(publicVapidKey)}).then(function(e){console.log("Subscribing"),fetch(`${window._push_host}/subscribe`,{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})})}function urlBase64ToUint8Array(e){const a=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(a),s=new Uint8Array(t.length);for(let e=0;e<t.length;++e)s[e]=t.charCodeAt(e);return s}window._push_host="https://escalade-montesquieu-pusher.herokuapp.com","serviceWorker"in navigator&&send().catch(e=>console.error(e)),getForumsLastMessages();
