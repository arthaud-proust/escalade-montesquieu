const months=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];try{window._last_message_id=window._messages[window._messages.length-1].id,localStorage.setItem(`${window._forum}.last_message`,new Date(window._messages[window._messages.length-1].created_at).getTime())}catch(e){window._last_message_id=0}const formUrlEncoded=e=>Object.keys(e).reduce((s,a)=>s+`&${a}=${encodeURIComponent(e[a])}`,"");function getDate(e,s=!0,a=!1){let t=void 0===e?"":new Date(e.replace(/-/g,"/"));const o=e=>0==e?"":1==e.toString().length?"0"+e:e;return`${t.getDate()} ${months[t.getMonth()]} ${a?`<small>${t.getFullYear()}</small>`:""} ${s?`à ${o(t.getHours())}h${o(t.getMinutes())}`:""}`}function getMessage(e){const s=anchorme({input:e.content,extensions:[{test:/@(\w|_)+/gi,transform:e=>`<a href="http://escalade-montesquieu.fr/profil/${e.substr(1).replace(/(_)+/gi," ")}">${e}</a>`}]});return`\n    <div class="MessageCard ${e.author==window._user?"myMessage":"theirMessage"}" id="message-${e.id}">\n        <a class="MessageCard-author" href="/profil/${e.author_uuid}" target="blank">\n                <img class="MessageCard-author-img" src="/profil/${e.author_uuid}/img">\n                <h5 class="MessageCard-author-name">\n                    ${e.author}\n                </h5>\n            </a>\n        <p class="MessageCard-text ">\n            ${s}\n        </p>\n        <span class="MessageCard-datetime">${getDate(e.created_at)}</span>\n    </div>\n    `}function addMessage(e){$("#MessagesList").append(getMessage(e)),$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},500)}function rendMessages(e){$("#MessagesList").html(e.map(e=>getMessage(e))),setTimeout(()=>{$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},250)},500)}function sendMessage(){if(!$("#MessageForm-input").val().match(/\S/gm))return;let e=$("#MessageForm-input").val();$("#MessageForm-input").val(""),$(".MessageForm").addClass("inProgress"),axios({method:"post",url:"/message/send",data:{forum:window._forum,content:e}}).then(e=>{$(".MessageForm").removeClass("inProgress"),window._last_message_id=e.data.message.id})}function fetchMessages(){return new Promise(e=>{console.log(`Fetching messages... (last: ${window._last_message_id})`),axios({method:"post",url:"https://escalade-montesquieu-pusher.herokuapp.com/fetch",timeout:3e4,data:formUrlEncoded({last_message_id:window._last_message_id,forum:window._forum})}).then(s=>{s.data.forEach(e=>{e.id>window._last_message_id&&(window._last_message_id=e.id,localStorage.setItem(`${window._forum}.last_message`,JSON.stringify(new Date(e.created_at).getTime()))),addMessage(e),window._messages.push(e)}),fetchMessages().then(()=>e(s))}).catch(e=>{fetchMessages()})})}$(()=>{$("#MessageForm-send").click(sendMessage),$("#MessageForm-input").keyup(function(e){13==e.which&&sendMessage()}),rendMessages(window._messages),fetchMessages()});
